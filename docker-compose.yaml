services:


    #Container für User-API
    postgres:
        image: postgres:16.11
        restart: unless-stopped
        ports:
        - "5432:5432"
        environment:
            POSTGRES_DB: userapi
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
        volumes:
        - postgres-data:/var/lib/postgresql/data
        networks:
        - sims-net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d userapi"]
            interval: 5s
            timeout: 5s
            retries: 10

    user-api:
        build: 
            context: ./sims-api
            dockerfile: Dockerfile
        restart: unless-stopped
        ports:
        - "5000:5000"
        environment:
        - ASPNETCORE_HTTP_PORTS=5000
        - ASPNETCORE_ENVIRONMENT=Development
        - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=userapi;Username=postgres;Password=postgres
        - Jwt__Key=noneofyourgoddamnbusinessthishastobesogoddamnverylongjesuschristandmariaandjoseph
        - Jwt__Issuer=sims-api
        depends_on:
            postgres:
                condition: service_healthy
        networks:
        - sims-net

    #Container für NoSQL EventLogging API
    redis:
        image: redis:8.4.0-bookworm
        container_name: redis
        ports:
        - "6379:6379"
        networks:
        - sims-net

    sims-nosql-api:
        build: 
            context: ./sims-nosql-api
            dockerfile: Dockerfile
        container_name: sims-nosql-api
        ports:
        - "8081:8080"
        depends_on:
        - redis
        networks:
        - sims-net
        
    #Container für BackendAPI
    backendapi:
        build:
            context: ./BackendApi
            dockerfile: Dockerfile
        image: backendapi
        ports:
        - "5001:5001"
        environment:
            ASPNETCORE_HTTP_PORTS: "5001"
            MSSQL_CONNECTION: "Data Source=mssql;User ID=sa;Password=eZW6FZ7zswB8Dzy@L9L9cAQBUt*@*jda;Database=SIMSData;TrustServerCertificate=true"
            REDIS_CONNECTION: "http://redis:6379"
        depends_on:
        - mssql
        networks:
        - sims-net

    mssql:
        image: mcr.microsoft.com/mssql/server:2025-RC1-ubuntu-24.04
        container_name: mssql
        environment:
            ACCEPT_EULA: "Y"
            MSSQL_SA_PASSWORD: "eZW6FZ7zswB8Dzy@L9L9cAQBUt*@*jda"
            MSSQL_PID: "Developer"
        ports:
        - "1433:1433"
        volumes:
        - mssql-data:/var/opt/mssql
        networks:
        - sims-net
        
    #Container für Web-App
    sims-web-app:
        build:
            context: ./sims-web_app
            dockerfile: Dockerfile
        container_name: sims-web-app
        ports:
        - "8080:8085"
        environment:
            ASPNETCORE_HTTP_PORTS: "8085"
            APP_UID: "${APP_UID:-1000}"
            DOTNET_RUNNING_IN_CONTAINER: "true"
            DOTNET_USE_POLLING_FILE_WATCHER: "true"
            BackendApiBaseUrl: "http://backendapi:5001/api/v1"
            AuthApiBaseUrl: "http://user-api:5000/api"
            LogApiBaseUrl: "http://sims-nosql-api:8080/api"
            JWT_KEY: "noneofyourgoddamnbusinessthishastobesogoddamnverylongjesuschristandmariaandjoseph"
            JWT_ISSUER: "sims-api"
            JWT_AUDIENCE: "sims-api"
        restart: unless-stopped
        working_dir: /app
        networks:
        - sims-net

    #Container für DependencyTrack (SBOM & Vulnerability Management)
    dependencytrack-postgres:
        image: postgres:16.11
        container_name: dependencytrack-postgres
        restart: unless-stopped
        ports:
        - "5433:5432"
        environment:
            POSTGRES_DB: dependencytrack
            POSTGRES_USER: dependencytrack
            POSTGRES_PASSWORD: dependencytrack
        volumes:
        - dependencytrack-data:/var/lib/postgresql/data
        networks:
        - sims-net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U dependencytrack -d dependencytrack"]
            interval: 5s
            timeout: 5s
            retries: 10

    dependencytrack:
        image: dependencytrack/apiserver:latest
        container_name: dependencytrack
        restart: unless-stopped
        ports:
        - "8082:8080"
        environment:
            ALPINE_DATABASE_MODE: external
            ALPINE_DATABASE_URL: jdbc:postgresql://dependencytrack-postgres:5432/dependencytrack
            ALPINE_DATABASE_DRIVER: org.postgresql.Driver
            ALPINE_DATABASE_USERNAME: dependencytrack
            ALPINE_DATABASE_PASSWORD: dependencytrack
            ALPINE_DATABASE_POOL_ENABLED: "true"
            ALPINE_DATABASE_POOL_MAX_SIZE: 20
        depends_on:
            dependencytrack-postgres:
                condition: service_healthy
        networks:
        - sims-net
        volumes:
        - dependencytrack-uploads:/data

    dependencytrack-frontend:
        image: dependencytrack/frontend:latest
        container_name: dependencytrack-frontend
        restart: unless-stopped
        ports:
        - "8083:80"
        environment:
            - API_BASE_URL=http://dependencytrack:8080
        depends_on:
        - dependencytrack
        networks:
        - sims-net
    
    
networks:
  sims-net:
    driver: bridge
    
volumes:
    postgres-data:
    mssql-data:
    dependencytrack-data:
    dependencytrack-uploads:
