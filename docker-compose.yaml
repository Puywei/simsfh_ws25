services:


    #Container f端r User-API
    postgres:
        image: postgres:16.11
        restart: unless-stopped
        ports:
        - "5432:5432"
        environment:
            POSTGRES_DB: userapi
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
        volumes:
        - postgres-data:/var/lib/postgresql/data
        networks:
        - sims-net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d userapi"]
            interval: 5s
            timeout: 5s
            retries: 10

    user-api:
        build: 
            context: ./sims-api
            dockerfile: Dockerfile
        restart: unless-stopped
        ports:
        - "5000:8080"
        environment:
        - ASPNETCORE_ENVIRONMENT=Development
        - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=userapi;Username=postgres;Password=postgres
        - Jwt__Key=noneofyourgoddamnbusinessthishastobesogoddamnverylongjesuschristandmariaandjoseph
        - Jwt__Issuer=sims-api
        depends_on:
            postgres:
                condition: service_healthy
        networks:
        - sims-net

    #Container f端r NoSQL EventLogging API
    redis:
        image: redis:8.4.0-bookworm
        container_name: redis
        ports:
        - "6379:6379"
        networks:
        - sims-net

    sims-nosql-api:
        build: 
            context: ./sims-nosql-api
            dockerfile: Dockerfile
        container_name: sims-nosql-api
        ports:
        - "8081:8080"
        depends_on:
        - redis
        networks:
        - sims-net
        
    #Container f端r BackendAPI
    backendapi:
        build:
            context: ./BackendApi
            dockerfile: Dockerfile
        image: backendapi
        ports:
        - "5001:5001"
        environment:
            ASPNETCORE_HTTP_PORTS: "5001"
            MSSQL_CONNECTION: "Data Source=mssql;User ID=sa;Password=eZW6FZ7zswB8Dzy@L9L9cAQBUt*@*jda;Database=SIMSData;TrustServerCertificate=true"
            REDIS_CONNECTION: "http://redis:6379"
        depends_on:
        - mssql
        networks:
        - sims-net

    mssql:
        image: mcr.microsoft.com/mssql/server:2025-RC1-ubuntu-24.04
        container_name: mssql
        environment:
            ACCEPT_EULA: "Y"
            MSSQL_SA_PASSWORD: "eZW6FZ7zswB8Dzy@L9L9cAQBUt*@*jda"
            MSSQL_PID: "Developer"
        ports:
        - "1433:1433"
        volumes:
        - mssql-data:/var/opt/mssql
        networks:
        - sims-net
        
    #Container f端r Web-App
    sims-web-app:
        build:
            context: ./sims-web_app
            dockerfile: Dockerfile
        container_name: sims-web-app
        ports:
        - "8080:8085"
        environment:
            ASPNETCORE_HTTP_PORTS: "8085"
            APP_UID: "${APP_UID:-1000}"
            DOTNET_RUNNING_IN_CONTAINER: "true"
            DOTNET_USE_POLLING_FILE_WATCHER: "true"
            BackendApiBaseUrl: "http://backendapi:5001/api/v1"
            AuthApiBaseUrl: "http://user-api:8080/api"
            LogApiBaseUrl: "http://sims-nosql-api:8081/api"
            JWT_KEY: "noneofyourgoddamnbusinessthishastobesogoddamnverylongjesuschristandmariaandjoseph"
            JWT_ISSUER: "sims-api"
            JWT_AUDIENCE: "sims-api"
        restart: unless-stopped
        working_dir: /app
        networks:
        - sims-net
    
    
networks:
  sims-net:
    driver: bridge
    
volumes:
    postgres-data:
    mssql-data:
