@page "/incidents_overview"
@using RestSharp; 
@using System.Text.Json; 



<PageTitle>Incidents Overview</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Incidents Overview</MudText>
<MudText Typo="Typo.body1" Class="mb-8">Security Incidents</MudText>


<NavLink href="/New_Ticket"><MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary">Create new Ticket</MudButton></NavLink>

<MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Medium" />

@if (incidents == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudTable Items="incidents" Hover="true" SortLabel="Sort By" Elevation="0" AllowUnsorted="false">
        <HeaderContent>
            <MudTh></MudTh>
            <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<IncidentsOverview, object>(x => x.incId)">Incident ID</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<IncidentsOverview, object>(x => x.subject)">Subject</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<IncidentsOverview, object>(x => x.severity)">Severity</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<IncidentsOverview, object>(x => x.AssignedPerson!)">Assigned Person</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<IncidentsOverview, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<IncidentsOverview, object>(x => x.createDate)">created Date</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<IncidentsOverview, object>(x => x.TimeToResolution)">Time to Resolution</MudTableSortLabel></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Enabled"><MudCheckBox T="bool" Checked="@context.selected" ValueChanged="@(e => UpdateRecord(context, e))"></MudCheckBox></MudTd>
            <MudTd DataLabel="Key"><MudLink Href="/INC">@context.incId</MudLink></MudTd>
            <MudTd DataLabel="summary">@context.subject</MudTd>
            <MudTd DataLabel="author">@context.severity</MudTd>
            <MudTd DataLabel="assigned_person">@context.AssignedPerson</MudTd>
            <MudTd DataLabel="assigned_person">@context.Status</MudTd>
            <MudTd DataLabel="assigned_person">@context.createDate</MudTd>
            <MudTd DataLabel="assigned_person">@context.TimeToResolution</MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 50, 100 }" />
        </PagerContent>
    </MudTable>

}



@code {

    public bool Basic_CheckBox1 { get; set; } = true;
    private IncidentsOverview[]? incidents;

    private const string ApiBaseUrl = "hier URL";
    private const string IncidentsEndpoint = "/api/incidents  Path?????";


    protected override async Task OnInitializedAsync()
    {
        /*
        try
        {
        // 1. Create RestClient
            var options = new RestClientOptions(ApiBaseUrl);
            var client = new RestClient(options);

        // 2. Create GET request
            var request = new RestRequest(IncidentsEndpoint, Method.Get);

            // If your API needs auth, add headers here:
            // request.AddHeader("Authorization", "Bearer YOUR_TOKEN_HERE");

        // 3. Execute the request
            var response = await client.ExecuteAsync(request);

        if (!response.IsSuccessful || string.IsNullOrWhiteSpace(response.Content))
            {
                Console.Error.WriteLine($"Failed to load incidents. Status: {response.StatusCode}, Error: {response.ErrorMessage}");
                incidents = new List<IncidentsOverview>();
                return;
            }




        }
        */

        //values from database
        incidents = new IncidentsOverview[2];
        incidents[0] = new IncidentsOverview();
        incidents[0].incId = "INC01";
        incidents[0].subject = "Our first incident";
        incidents[0].severity = "high";
        incidents[0].AssignedPerson = "Konatsu Macala";
        incidents[0].Status = "Open";
        incidents[0].createDate = DateOnly.FromDateTime(DateTime.Now);
        incidents[0].TimeToResolution = DateOnly.FromDateTime(DateTime.Now).AddDays(5);

        incidents[1] = new IncidentsOverview();
        incidents[1].incId = "INC02";
        incidents[1].subject = "Our second incident";
        incidents[1].severity = "low";
        incidents[1].AssignedPerson = "Gabriel Grabner";
        incidents[1].Status = "closed";
        incidents[1].createDate = DateOnly.FromDateTime(DateTime.Now).AddDays(-5);
        incidents[1].TimeToResolution = DateOnly.FromDateTime(DateTime.Now).AddDays(-3);

        


    }

    private async Task UpdateRecord(IncidentsOverview record, bool ischecked)
    {
        record.selected = ischecked;

    }

    public class IncidentsOverview
    {
        public string incId { get; set; }
        public string subject { get; set; }
        public string severity { get; set; }
        public string? AssignedPerson { get; set; }
        public string? Status { get; set; }
        public DateOnly createDate { get; set; }
        public DateOnly TimeToResolution { get; set; }
        public bool selected { get; set; }
    }
}


