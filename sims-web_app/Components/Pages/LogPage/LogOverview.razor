@page "/logoverview"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@using sims_web_app.Components.Identity.Contracts
@using sims_web_app.Components.Identity.Services
@using MudBlazor
@using System.Net.Http.Json
@using sims_web_app.Data.Model
@inject HttpClient Http

<PageTitle>Log Overview</PageTitle>

<MudPaper Class="pa-4" Elevation="3">
    <MudText Typo="Typo.h5" Class="mb-4">Log Overview</MudText>

    <MudTable Items="pagedLogs" Elevation="0" Hover="true" Bordered="true">
        <HeaderContent>
            <MudTh>Timestamp</MudTh>
            <MudTh>Method</MudTh>
            <MudTh>Path</MudTh>
            <MudTh>User</MudTh>
            <MudTh>Body</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Timestamp">@context.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
            <MudTd DataLabel="Method">@context.Method</MudTd>
            <MudTd DataLabel="Path">@context.Path</MudTd>
            <MudTd DataLabel="User">@context.User</MudTd>
            <MudTd DataLabel="Body">@context.Body</MudTd>
        </RowTemplate>
    </MudTable>

    <MudTablePager PageSizeOptions="new int[]{5,10,20}" PageSize="pageSize" PageIndex="pageIndex"
                   OnPageChanged="OnPageChanged" Class="mt-4"/>
</MudPaper>

@code {
    private List<LogEntry> logs = new();
    private List<LogEntry> pagedLogs = new();
    private int pageSize = 10;
    private int pageIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadLogsAsync();
        UpdatePagedLogs();
    }

    private async Task LoadLogsAsync()
    {
        try
        {
            // ruft die letzten 50 Logs von der API
            logs = (await Http.GetFromJsonAsync<List<LogEntry>>("http://localhost:5001/api/logs?count=50")) ?? new List<LogEntry>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler beim Laden der Logs: {ex.Message}");
        }
    }

    private void UpdatePagedLogs()
    {
        pagedLogs = logs.Skip(pageIndex * pageSize).Take(pageSize).ToList();
    }

    private void OnPageChanged(int index)
    {
        pageIndex = index;
        UpdatePagedLogs();
    }
}
