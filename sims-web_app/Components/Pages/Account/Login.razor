@page "/login"

@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using sims_web_app.Components.Data
@using sims_web_app.Components.Models.Entities
@using sims_web_app.Components.Models.ViewModels
@inject AppDbContext AppDbContext;
@inject NavigationManager navigationManager;

<PageTitle>Login to SIMS</PageTitle>
<MudGrid Justify="Justify.Center">
    <EditForm Model="@LoginViewModel" OnValidSubmit="Authenticate">
        <DataAnnotationsValidator />
        <MudCard Class="demo-form">
            <MudCardContent>
                <MudTextField Label="Username" HelperText="Max. 8 characters" @bind-Value="LoginViewModel.Username" For="@(() => LoginViewModel.Username)" />
                <MudTextField Label="Password"  @bind-Value="LoginViewModel.Password" For="@(() => LoginViewModel.Password)" InputType="InputType.Password" />
            </MudCardContent>
            <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="demo-form-button">Login</MudButton>
            </MudCardActions>
        </MudCard>    
    </EditForm>
</MudGrid>


@code {
    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }
    
    [SupplyParameterFromForm] public LoginViewModel LoginViewModel { get; set; } = new();

    private string? errorMessage;
    
    private async Task Authenticate()
    {
        UserAccount userAccount = AppDbContext.UserAccounts.FirstOrDefault(entry => entry.Username == LoginViewModel.Username);
        if (userAccount is null || userAccount.Password != LoginViewModel.Password)
        {
            errorMessage = "Username or password is incorrect";
            return;
        }

        List<Claim> claims = new List<Claim>
        {
            new Claim(ClaimTypes.Name, LoginViewModel.Username),
            new Claim(ClaimTypes.Role, userAccount.Role)
        };

        ClaimsIdentity identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        ClaimsPrincipal principal = new ClaimsPrincipal(identity);
        await HttpContext.SignInAsync(principal);
        navigationManager.NavigateTo("/");
    }
}