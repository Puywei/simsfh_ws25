@page "/Incident/create"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using sims_web_app.Components.Identity.Contracts
@using sims_web_app.Components.Identity.Services
@using sims_web_app.Data.Model.Enum
@using sims_web_app.Data.Model
@using sims_web_app.Services
@inject NavigationManager NavManager
@inject AuthApiHandler AuthApiHandler

<PageTitle>New Ticket</PageTitle>

<MudForm @ref="form" OnValidSubmit="SubmitIncident">
    <MudText Typo="Typo.h3" GutterBottom="true">Create New Ticket</MudText>
    <MudText Typo="Typo.body1" Class="mb-8">You can create a new incident Ticket here.</MudText>
    <MudTextField @bind-Value="newIncident.Summary" Label="Subject" Variant="Variant.Outlined"></MudTextField>
    <MudTextField @bind-Value="newIncident.CustomerId" Label="Customer ID" Variant="Variant.Outlined"></MudTextField>

    <MudSelect T="int?" Placeholder="choose a person" FullWidth="true" @bind-Value="newIncident.AssignedPerson" Class="mt-3">
        @foreach (var user in users)
        {
            <MudSelectItem Value="@user.uid">@($"{user.FirstName} {user.LastName}")</MudSelectItem>
        }
    </MudSelect>
    <MudGrid>
        <MudItem xs="12">
            <MudField Label="Severity" Variant="Variant.Outlined" InnerPadding="false">
                <MudRadioGroup T="IncidentSeverity?" Required="true" @bind-Value="newIncident.Severity" Label="Severity">
                    <MudRadio T="IncidentSeverity?" Value="IncidentSeverity.Low">Low</MudRadio>
                    <MudRadio T="IncidentSeverity?" Value="IncidentSeverity.Medium">Medium</MudRadio>
                    <MudRadio T="IncidentSeverity?" Value="IncidentSeverity.High">High</MudRadio>
                    <MudRadio T="IncidentSeverity?" Value="IncidentSeverity.Critical">Critical</MudRadio>
                </MudRadioGroup>
            </MudField>
        </MudItem>
    </MudGrid>
    <MudTextField T="string" Label="Description" Variant="Variant.Outlined" @bind-Value="newIncident.Description" Lines="10" />
    <MudButton Variant="Variant.Filled" ButtonType="ButtonType.Submit" OnClick="(() => SubmitIncident())" StartIcon="@Icons.Material.Filled.Save" Color="Color.Info" Size="Size.Medium">Save</MudButton>
</MudForm>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="my-4">@errorMessage</MudAlert>
}


@code {
    private string errorMessage = string.Empty;
    private MudForm form;
    private Data.Model.Incident newIncident = new Data.Model.Incident();
    private List<User> users = new List<User>();

    protected override async void OnInitialized()
    {
        users = await AuthApiHandler.GetAllUsers();
    }

    private async Task SubmitIncident()
    {
        newIncident.AssignedPersonName = users.Find(u => u.uid == newIncident.AssignedPerson).FullName;
        await BackendApiHandler.CreateIncident(newIncident);
    }
}
