@page "/Incident/Overview"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using sims_web_app.Services
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthApiHandler AuthApiHandler

<PageTitle>Incidents Overview</PageTitle>

<MudPaper Class="pa-6" Elevation="2">
    <MudStack Spacing="2">
        <MudText Typo="Typo.h4" Color="Color.Primary">Incidents Overview</MudText>
        <MudText Typo="Typo.body2" Color="Color.Default">Security Incidents</MudText>

        @if (!isDone)
        {
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1">Daten werden geladen...</MudText>
        }
        else
        {
            
            <MudDataGrid Items="_incidents">
                <ToolBarContent>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateIncidentDialog"
                               StartIcon="@Icons.Material.Filled.Add">
                        New Incident
                    </MudButton>
                </ToolBarContent>

                <Columns>
                    <!-- CompanyName klickbar -->
                    <PropertyColumn Property="x => x.Id" Title="Id" />
                    <PropertyColumn Property="x => x.Summary" Title="Subject" />
                    <PropertyColumn Property="x => x.Severity" Title="Severity" />
                    <PropertyColumn Property="x => x.AssignedPerson" Title="Assigned Person" />
                    <PropertyColumn Property="x => x.Status" Title="Status" />
                    <PropertyColumn Property="x => x.CreateDate" Title="CreateDate" />

                    <!-- Aktionen -->
                    <TemplateColumn Title="Aktionen">
                        <CellTemplate Context="x">
                            @if (x.Item.Id == "No Data Found")
                            {
                                
                            }
                            else
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Color="Color.Primary"
                                               OnClick="async () => await OpenEditIncidentDialog(x.Item)"/>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               OnClick="async () => await ConfirmDeleteIncident(x.Item.Id, x.Item.Summary)"/>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>

                 <PagerContent>
                    <MudDataGridPager/>
                </PagerContent>
                </MudDataGrid>
        }
    </MudStack>
</MudPaper>

@code {
    private bool isDone = false;
    private List<Data.Model.Incident> _incidents = new List<Data.Model.Incident>();
    private string _searchString = "";

    protected override async Task OnInitializedAsync()
    {
      try
      {
        _incidents = await BackendApiHandler.GetAllIncidents();
        if (_incidents is null)
            _incidents = new List<Data.Model.Incident>()
            {
                new Data.Model.Incident { Id = "No Data Found", Summary = "No Data Found" }
            };

      }
      catch (Exception e)
      {
        Console.WriteLine(e);
      }
      isDone = true;
    }
    private async Task LoadData()
    {
        _incidents = await BackendApiHandler.GetAllIncidents();
        if (_incidents is null)
            _incidents = new List<Data.Model.Incident>()
            {
                new Data.Model.Incident { Id = "No Data Found", Summary = "No Data Found" }
            };
        await InvokeAsync(StateHasChanged);
    }

    private async Task ConfirmDeleteIncident(string id, string incidentSubject)
    {
        var parameters = new DialogParameters
        {
            { nameof(DeleteIncidentDialog.ContentText), $"Do you really want to delete the incident {incidentSubject}? This process cannot be undone." },
            { nameof(DeleteIncidentDialog.ButtonText), "Delete" },
            { nameof(DeleteIncidentDialog.Color), Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = DialogService.Show<DeleteIncidentDialog>("Delete", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            DeleteIncident(id, incidentSubject);
        }
    }

    private async Task DeleteIncident(string id, string incidentSubject)
    {
        try
        {
            bool isDeleted = await BackendApiHandler.DeleteIncident(id);

            if (isDeleted)
            {
                Snackbar.Add($"Incident {incidentSubject} wurde erfolgreich gelöscht.", Severity.Success);
                _incidents = await BackendApiHandler.GetAllIncidents();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add($"Incident mit ID {incidentSubject} konnte nicht gelöscht.", Severity.Error);
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
    }

    private async Task OpenCreateIncidentDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<CreateIncidentDialog>("Create New Incident", options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {

            await LoadData();
        }

        StateHasChanged();
    }

    private async Task OpenEditIncidentDialog(sims_web_app.Data.Model.Incident incident)
    {
        var parameters = new DialogParameters
        {
            { nameof(EditIncidentDialog.IncidentToEdit), incident }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = DialogService.Show<EditIncidentDialog>("Incidents bearbeiten", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            StateHasChanged();
        }
    }

       }
