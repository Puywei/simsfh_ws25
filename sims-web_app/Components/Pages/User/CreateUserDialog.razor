@using sims_web_app.Data.Model
@using MudBlazor
@using sims_web_app.Services
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@inject ISnackbar Snackbar
@inject AuthApiHandler AuthApiHandler


<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="_user.FirstName" Label="Firstname" Required="true" />
        <MudTextField @bind-Value="_user.LastName" Label="Lastname" Required="true" />
        <MudTextField @bind-Value="_user.Email" Label="E-Mail" Required="true" />
        <MudSelect T="int" Placeholder="Rolle wählen" FullWidth="true" @bind-Value="_user.RoleId" Class="mt-3">
            @foreach (var role in _userRoles)
            {
                <MudSelectItem Value="@role.RoleId">@($"{role.RoleName}")</MudSelectItem>
            }
        </MudSelect>
        <MudTextField Label="Password" HelperText="Choose a strong password" @bind-Value="_user.Password" For="@(() => _user.Password)" InputType="InputType.Password" />
        <MudTextField Label="Password" HelperText="Repeat the password" @bind-Value="_passVerify" For="@(() => _passVerify)" InputType="InputType.Password" />
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Default" OnClick="Cancel">Abbrechen</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save">Speichern</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private User _user = new();
    private string _passVerify = "";

    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

    private List<UserRole> _userRoles = new List<UserRole>();
    
    private void Cancel() => MudDialog.Cancel();

    private async void Save()
    {
        bool isCreated = await AuthApiHandler.CreateUser(_user);
        MudDialog.Close(DialogResult.Ok(_user));

        if (_user.Password == _passVerify)
        {
            if (isCreated)
            {
                Snackbar.Add($"Customer {_user.Email} created successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error by creating the customer!", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add($"Password does not match!", Severity.Error);
        }
        

    }

    protected override  async void OnInitialized()
    {
        _userRoles = await AuthApiHandler.GetAllRoles();
    }
}