@page "/User/Overview"
@attribute [Authorize(Roles ="Admin")]
@using Microsoft.AspNetCore.Authorization
@using sims_web_app.Components.Identity.Contracts
@using sims_web_app.Components.Identity.Services
@using sims_web_app.Data.Model
@using sims_web_app.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthApiHandler AuthApiHandler


<PageTitle>User Overview</PageTitle>



<MudPaper Class="pa-6" Elevation="2">
    <MudStack Spacing="2">
        <MudText Typo="Typo.body2" Color="Color.Default">
            Übersicht aller User im System
        </MudText>
        @if (!isDone)
        {
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1">Daten werden geladen...</MudText>
        }
        else
        {
            <MudDataGrid Items="_users">
                <ToolBarContent>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateUserDialog"
                               StartIcon="@Icons.Material.Filled.Add">
                        Neuer Kunde
                    </MudButton>
                </ToolBarContent>

                <Columns>
                    <!-- CompanyName klickbar -->
                    <PropertyColumn Property="x => x.FirstName" Title="Firstname" />
                    <PropertyColumn Property="x => x.LastName" Title="Lastname" />
                    <PropertyColumn Property="x => x.Email" Title="E-Mail" />
                    <PropertyColumn Property="x => x.RoleId" Title="Rolle" />

                    <!-- Aktionen -->
                    <TemplateColumn Title="Aktionen">
                        <CellTemplate Context="x">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           OnClick="async () => await OpenEditUserDialog(x.Item)"/>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           OnClick="async () => await ConfirmDeleteUser(x.Item.uid, x.Item.Email)" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>

                <PagerContent>
                    <MudDataGridPager/>
                </PagerContent>
            </MudDataGrid>
        }
    </MudStack>
</MudPaper>

@code {
    private bool isDone = false;
    private List<User> _users = new List<User>();
    private string _searchString = "";
    
    private List<UserRole> roles = new List<UserRole>()
    {
        new UserRole {Id = 0, Name = "Admin" },
        new UserRole {Id = 1, Name = "User" }
    };
    

    public async Task<string> GetRoleName(int roleId)
    {
        return roles.First(r => r.Id == roleId).Name;
    }
    

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _users = await AuthApiHandler.GetAllUsers();
            
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
        isDone = true;
    }
    private async Task LoadData()
    {
        _users = await AuthApiHandler.GetAllUsers();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ConfirmDeleteUser(int id, string customerName)
    {
        var parameters = new DialogParameters
        {
            { nameof(DeleteUserDialog.ContentText), $"Do you really want to delete user {customerName}?"},
            { nameof(DeleteUserDialog.ButtonText), "Delete" },
            { nameof(DeleteUserDialog.Color), Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = DialogService.Show<DeleteUserDialog>("Delete", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await DeleteCustomer(id, customerName);
        }
    }
    
    private async Task DeleteCustomer(int id, string customerName)
    {
        try
        {
            bool isDeleted = await AuthApiHandler.DeleteUser(id);

            if (isDeleted)
            {
                Snackbar.Add($"User {customerName} deleted successfully.", Severity.Success);
                _users = await AuthApiHandler.GetAllUsers();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add($"User with ID {customerName} could not be deleted.", Severity.Error);
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
    }
    
    private async Task OpenCreateUserDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<CreateUserDialog>("Create new user", options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {

            await LoadData();
        }

        StateHasChanged();
    }
    
    private async Task OpenEditUserDialog(User user)
    {
        var parameters = new DialogParameters
        {
            { nameof(EditUserDialog.UserToEdit), user }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = DialogService.Show<EditUserDialog>("Modify user", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            StateHasChanged();
        }
    }


}
